<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Infinite Year Calendar</title>
  <style>
    body {
      display: flex;
      height: 100vh;
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
    }
    .calendar {
      flex: 0 0 80%;
      padding: 20px;
      background: #fff;
      border-right: 2px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .calendar-header {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }
    .calendar-header h1 {
      font-size: 1.5rem;
      color: #2c3e50;
    }
    select {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      max-height: 150px; /* allow scrolling */
      overflow-y: auto;
    }
    table {
      border-collapse: collapse;
      width: 90%;
      max-width: 800px;
      background: #fafafa;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ddd;
      text-align: center;
      padding: 15px;
    }
    th {
      background: #3498db;
      color: #fff;
    }
    td {
      height: 80px;
      transition: background 0.3s;
    }
    td:hover {
      background: #ecf0f1;
      cursor: pointer;
    }
    .input-menu {
      flex: 0 0 20%;
      padding: 30px;
      background: #f0f4f8;
    }
    .input-menu h2 {
      margin-bottom: 20px;
      font-size: 1.5rem;
      color: #34495e;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }
    input[type="text"], select.form-select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    button {
      padding: 12px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
    }
    button:hover {
      background: #2980b9;
    }
    .day-wheel {
      max-height: 100px;
      overflow-y: auto;
      margin-top: 5px;
      font-size: 0.8rem;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .day-wheel div {
      padding: 4px;
      cursor: pointer;
    }
    .day-wheel div:hover {
      background: #e0e0e0;
    }
    .scroll {
      flex: 0 0 20%;
      background-color: #fed9ff;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
      border-left: 2px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #setpoints h1 {
      margin-top: 0;
      font-size: 1.4rem;
      color: #6c3483;
    }

    #setpoints p {
      background: #ffffff;
      padding: 10px 12px;
      margin: 8px 0;
      width: 90%;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      font-size: 0.9rem;
    }

  </style>
</head>
<body>
  <div class="scroll" id="setpoints">
    <h1>Setpoints</h1>
  </div>
  <div class="calendar">
    <div class="calendar-header">
      <h1 id="monthYear"></h1>
      <select id="monthSelect"></select>
      <button id="yearToggle"></button>
      <select id="yearSelect" size="6" style="display:none;"></select>
    </div>
    <table>
      <thead>
        <tr>
          <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th>
          <th>Thu</th><th>Fri</th><th>Sat</th>
        </tr>
      </thead>
      <tbody id="calendarBody"></tbody>
    </table>
  </div>
  <div class="input-menu" >
    <h2>Input data</h2>
    <form action="/submit" method="POST">
      <div class="form-group">
        <label for="tasks">Task:</label>
        <input type="text" id="tasks" name="tasks" placeholder="task: "/>
      </div>
      <div class="form-group">
        <label for="retention_factor">Retention factor:</label>
        <input type="text" id="retention_factor" name="retention_factor" placeholder="retention factor: "/>
      </div>
      <div class="form-group">
        <label for="n">Number of data points:</label>
        <input type="text" id="n" name="n" placeholder="Number of data points(IE number of questions): "/>
      </div>
      <div class="form-group">
        <label for="effort">Learning effort:</label>
        <input type="text" id="effort" name="effort" placeholder="Enter effort">
      </div>
      <div class="form-group">
        <label for="units">Units:</label>
        <select id="units" name="units" class="form-select">
          <option value="minutes">Minutes</option>
          <option value="repetitions">Repetitions</option>
        </select>
      </div>
      <div class="form-group">
        <label for="date">Date/time:</label>
        <div style="display:flex; gap:10px;">
          <input type="date" id="date" name="date">
          <input type="time" id="time" name="time">
        </div>
      </div>
      <button type="submit">Submit</button>
    </form>
  </div>

  <script>
    const monthNames = [
      "January","February","March","April","May","June",
      "July","August","September","October","November","December"
    ];
    const monthSelect = document.getElementById("monthSelect");
    const yearSelect = document.getElementById("yearSelect");
    const monthYear = document.getElementById("monthYear");
    const calendarBody = document.getElementById("calendarBody");

    // Populate months
    monthNames.forEach((m,i)=>{
      const opt=document.createElement("option");
      opt.value=i; opt.textContent=m;
      monthSelect.appendChild(opt);
    });

    // Procedural year generation
    let minYear = new Date().getFullYear()-5;
    let maxYear = new Date().getFullYear()+5;
    function populateYears(start,end){
      for(let y=start;y<=end;y++){
        if(!document.querySelector(`#yearSelect option[value="${y}"]`)){
          const opt=document.createElement("option");
          opt.value=y; opt.textContent=y;
          yearSelect.appendChild(opt);
        }
      }
    }
    populateYears(minYear,maxYear);

    // Infinite scroll listener
    yearSelect.addEventListener("scroll",()=>{
      const scrollBottom = yearSelect.scrollTop + yearSelect.clientHeight;
      if(scrollBottom >= yearSelect.scrollHeight-5){
        // add more future years
        maxYear+=10;
        populateYears(maxYear-9,maxYear);
      }
      if(yearSelect.scrollTop===0){
        // add more past years
        minYear-=10;
        const fragment=document.createDocumentFragment();
        for(let y=minYear;y<minYear+10;y++){
          if(!document.querySelector(`#yearSelect option[value="${y}"]`)){
            const opt=document.createElement("option");
            opt.value=y; opt.textContent=y;
            fragment.insertBefore(opt,fragment.firstChild);
          }
        }
        yearSelect.insertBefore(fragment,yearSelect.firstChild);
      }
    });

    function generateCalendar(month,year){
      calendarBody.innerHTML="";
      monthYear.textContent=`${monthNames[month]} ${year}`;
      const firstDay=new Date(year,month,1).getDay();
      const daysInMonth=new Date(year,month+1,0).getDate();
      let date=1;
      for(let i=0;i<6;i++){
        const row=document.createElement("tr");
        for(let j=0;j<7;j++){
          const cell=document.createElement("td");
          if(i===0 && j<firstDay){
            cell.textContent="";
          } else if(date>daysInMonth){
            cell.textContent="";
          } else {
                        // create wheel element directly
            const wheel = document.createElement("div");
            wheel.className = "day-wheel";
            cell.innerHTML = `<div>${date}</div>`;
            cell.appendChild(wheel);

            // highlight today
            const today = new Date();
            if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
              cell.style.background = "#ffeaa7";
              cell.style.fontWeight = "bold";
            }

            // fetch data for this date
            const formattedDate = `${year}-${String(month+1).padStart(2,"0")}-${String(date).padStart(2,"0")}`;
            fetch(`/get_date/${formattedDate}`)
              .then(res => res.json())
              .then(items => {
                if (!items) {
                  wheel.innerHTML = "";
                  return;
                }
                const times = Object.keys(items);
                wheel.innerHTML = "";
                times.forEach(t => {
                  const timeDiv = document.createElement("div");
                  timeDiv.textContent = t;
                  timeDiv.addEventListener("click", () => {
                    window.location.href = `/get_datetime/${formattedDate}/${t}`;
                  });
                  wheel.appendChild(timeDiv);
                });
              })
              .catch(err => {
                console.error("Error fetching date data:", err);
              });
            date++;
          }
          row.appendChild(cell);
        }
        calendarBody.appendChild(row);
      }
    }

    // Initialize
    const today=new Date();
    const yearToggle = document.getElementById("yearToggle");
    yearToggle.textContent = today.getFullYear();

    yearToggle.addEventListener("click", () => {
      yearSelect.style.display = yearSelect.style.display === "none" ? "block" : "none";
    });

    monthSelect.value=today.getMonth();
    yearSelect.value=today.getFullYear();
    generateCalendar(today.getMonth(),today.getFullYear());

    monthSelect.addEventListener("change",()=>{
      generateCalendar(parseInt(monthSelect.value),parseInt(yearSelect.value));
    });
    yearSelect.addEventListener("change",()=>{
      generateCalendar(parseInt(monthSelect.value),parseInt(yearSelect.value));
    });
    const setpoints = document.getElementById("setpoints")
    fetch("/get_setpoints").then(res=>res.json()).then(items=>items.forEach((item)=>{
      const P_element = document.createElement("p")
      P_element.textContent = item
      const anchor_element = document.createElement("a")
      anchor_element.href = "/get_setpoint/"+items
      anchor_element.appendChild(P_element)
      setpoints.appendChild(anchor_element)
    }))
  </script>
</body>
</html>